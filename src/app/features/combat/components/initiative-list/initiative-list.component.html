<section class="initiative-list">
  <!-- Header -->
  <header class="initiative-header">
    <div class="header-content">
      <h2 class="initiative-title">
        <span class="material-symbols-outlined">format_list_numbered</span>
        Initiative Tracker
      </h2>
      @if (combatState().isActive) {
        <span class="round-badge">Round {{ combatState().round }}</span>
      }
    </div>
    
    <!-- Combat Controls -->
    <div class="combat-controls">
      @if (!combatState().isActive) {
        <button 
          class="btn btn-primary"
          [disabled]="combatState().initiative.length === 0"
          (click)="startCombat()"
        >
          <span class="material-symbols-outlined">play_arrow</span>
          Start Combat
        </button>
      } @else {
        <button class="btn btn-ghost" (click)="previousTurn()">
          <span class="material-symbols-outlined">skip_previous</span>
        </button>
        <button class="btn btn-primary" (click)="nextTurn()">
          <span class="material-symbols-outlined">skip_next</span>
          Next Turn
        </button>
        <button class="btn btn-ghost btn-danger" (click)="endCombat()">
          <span class="material-symbols-outlined">stop</span>
          End
        </button>
      }
    </div>
  </header>

  <!-- Current Turn Display -->
  @if (combatState().isActive && currentTurnEntry(); as current) {
    <div class="current-turn-display">
      <span class="current-label">Current Turn</span>
      <span class="current-name">{{ current.name }}</span>
      <span class="current-initiative">{{ current.initiative }}</span>
    </div>
  }

  <!-- Initiative List -->
  <div class="initiative-entries">
    @if (sortedInitiative().length === 0) {
      <div class="empty-state">
        <span class="material-symbols-outlined">group_add</span>
        <p>No combatants added yet</p>
        <p class="hint">Add characters or NPCs to begin tracking initiative</p>
      </div>
    } @else {
      @for (entry of sortedInitiative(); track entry.id) {
        <div 
          class="initiative-entry"
          [class.current-turn]="entry.isCurrentTurn"
          [class.is-player]="entry.isPlayer"
          [class.is-npc]="!entry.isPlayer"
        >
          <div class="entry-indicator">
            @if (entry.isCurrentTurn) {
              <span class="material-symbols-outlined turn-marker">arrow_right</span>
            }
          </div>
          
          <span class="entry-icon material-symbols-outlined">
            {{ getEntryIcon(entry) }}
          </span>
          
          <div class="entry-info">
            <span class="entry-name">{{ entry.name }}</span>
            @if (entry.notes) {
              <span class="entry-notes">{{ entry.notes }}</span>
            }
          </div>
          
          <span class="entry-initiative">{{ entry.initiative }}</span>
          
          <button 
            class="remove-btn"
            (click)="removeEntry(entry.id)"
            title="Remove from initiative"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
      }
    }
  </div>

  <!-- Add Entry Section -->
  <div class="add-section">
    @if (!showAddForm()) {
      <div class="add-buttons">
        <button class="btn btn-secondary" (click)="toggleAddForm()">
          <span class="material-symbols-outlined">person_add</span>
          Add Character
        </button>
        <button class="btn btn-ghost" (click)="addQuickNpc()">
          <span class="material-symbols-outlined">smart_toy</span>
          Quick Add NPC
        </button>
      </div>
    } @else {
      <div class="add-form">
        <h3 class="form-title">Add to Initiative</h3>
        
        <!-- Character Selection -->
        <div class="form-group">
          <label class="form-label">Select Character (Optional)</label>
          <select 
            class="form-input"
            (change)="onCharacterSelect($event)"
          >
            <option value="">-- Manual Entry --</option>
            @for (char of characters(); track char.id) {
              <option [value]="char.id">{{ char.name }}</option>
            }
          </select>
        </div>

        <!-- Name Input -->
        <div class="form-group">
          <label class="form-label">Name</label>
          <input 
            type="text"
            class="form-input"
            [value]="newEntryName()"
            (input)="newEntryName.set($any($event.target).value)"
            placeholder="Enter name..."
          />
        </div>

        <!-- Initiative Input -->
        <div class="form-row">
          <div class="form-group flex-1">
            <label class="form-label">Initiative</label>
            <input 
              type="number"
              class="form-input"
              [value]="newEntryInitiative()"
              (input)="newEntryInitiative.set(+$any($event.target).value)"
              placeholder="0"
            />
          </div>
          
          @if (selectedCharacterId()) {
            <button 
              class="btn btn-secondary roll-initiative-btn"
              (click)="rollInitiativeForCharacter()"
            >
              <span class="material-symbols-outlined">casino</span>
              Roll
            </button>
          }
        </div>

        <!-- Is Player Toggle -->
        <div class="form-group">
          <label class="toggle-label">
            <input 
              type="checkbox"
              [checked]="newEntryIsPlayer()"
              (change)="newEntryIsPlayer.set($any($event.target).checked)"
            />
            <span class="toggle-text">Is Player Character</span>
          </label>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button class="btn btn-ghost" (click)="toggleAddForm()">Cancel</button>
          <button 
            class="btn btn-primary"
            [disabled]="!newEntryName() || newEntryInitiative() === null"
            (click)="addEntry()"
          >
            Add to Initiative
          </button>
        </div>
      </div>
    }
  </div>
</section>
