<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DICE CALCULATOR COMPONENT
     Calculate dice pools for simple stat rolls and combat actions
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section class="dice-calculator panel">
  <!-- Panel Header -->
  <header class="panel__header">
    <h2 class="panel__title">
      <span class="material-symbols-outlined">casino</span>
      Dice Calculator
    </h2>
    <p class="panel__subtitle">Calculate and roll your dice pools</p>
  </header>

  <!-- Character Selection -->
  <div class="character-select-wrapper">
    <label for="character-select" class="form-label">Select Character</label>
    <select 
      id="character-select" 
      class="form-select"
      (change)="onCharacterSelect($event)"
    >
      <option value="">â€” Choose a character â€”</option>
      @for (char of characters(); track char.id) {
        <option [value]="char.id">{{ char.name }} (Level {{ char.level }})</option>
      }
    </select>
  </div>

  @if (selectedCharacter(); as character) {
    <!-- Mode Toggle -->
    <div class="mode-toggle">
      <button 
        type="button"
        class="mode-toggle__btn"
        [class.is-active]="mode() === 'simple'"
        (click)="setMode('simple')"
      >
        <span class="material-symbols-outlined">target</span>
        Simple Roll
      </button>
      <button 
        type="button"
        class="mode-toggle__btn"
        [class.is-active]="mode() === 'combat'"
        (click)="setMode('combat')"
      >
        <span class="material-symbols-outlined">swords</span>
        Combat Roll
      </button>
    </div>

    <!-- Calculator Content Grid -->
    <div class="calculator-grid">
      <!-- Left: Selection Panel -->
      <div class="selection-panel">
        @if (mode() === 'simple') {
          <!-- Simple Mode: Stat Selection -->
          <div class="stat-selection">
            <div class="stat-selection__header">
              <h3 class="section-title">Select Stats to Roll</h3>
              @if (selectedStats().size > 0) {
                <button 
                  type="button" 
                  class="stat-selection__clear"
                  (click)="clearStats()"
                  title="Clear all selected stats"
                >
                  <span class="material-symbols-outlined">close</span>
                  Clear All
                </button>
              }
            </div>

            <!-- CHANGED: Info message about multi-select -->
            @if (selectedStats().size === 0) {
              <p class="stat-selection__hint">
                <span class="material-symbols-outlined">info</span>
                Click stats to add them to your roll. You can select multiple stats.
              </p>
            } @else {
              <p class="stat-selection__hint stat-selection__hint--active">
                <span class="material-symbols-outlined">check_circle</span>
                {{ selectedStats().size }} stat{{ selectedStats().size > 1 ? 's' : '' }} selected
              </p>
            }
            
            @for (category of statCategories; track category) {
              <div class="stat-category">
                <h4 class="stat-category__title stat-category__title--{{ category }}">
                  {{ getStatCategoryLabel(category) }}
                </h4>
                <div class="stat-grid">
                  @for (stat of getStatsForCategory(category); track stat.abbr) {
                    <!-- CHANGED: Use toggleStat and isStatSelected instead of selectStat -->
                    <button 
                      type="button"
                      class="stat-btn"
                      [class.is-selected]="isStatSelected(stat.abbr)"
                      (click)="toggleStat(stat.abbr)"
                    >
                      <span class="stat-btn__abbr">{{ stat.abbr }}</span>
                      <span class="stat-btn__name">{{ stat.name }}</span>
                      <span class="stat-btn__value">{{ stat.value }}</span>
                      <span class="stat-btn__dice">{{ stat.dice }}D20 {{ formatModifier(stat.mod) }}</span>
                    </button>
                  }
                </div>
              </div>
            }
          </div>
        } @else {
          <!-- Combat Mode: Attack/Defense Selection -->
          <div class="combat-selection">
            <!-- Combat Tab Toggle -->
            <div class="combat-tabs">
              <button 
                type="button"
                class="combat-tabs__btn"
                [class.is-active]="combatTab() === 'attack'"
                (click)="setCombatTab('attack')"
              >
                <span class="material-symbols-outlined">bolt</span>
                Attack
              </button>
              <button 
                type="button"
                class="combat-tabs__btn"
                [class.is-active]="combatTab() === 'defense'"
                (click)="setCombatTab('defense')"
              >
                <span class="material-symbols-outlined">shield</span>
                Defense
              </button>
            </div>

            <!-- Attack/Defense Type Cards -->
            <div class="combat-type-list">
              @if (combatTab() === 'attack') {
                @for (formula of attackFormulas(); track formula.type) {
                  <button 
                    type="button"
                    class="combat-type-card"
                    [class.is-selected]="selectedAttackType() === formula.type"
                    (click)="selectAttackType(formula.type)"
                  >
                    <span class="combat-type-card__icon material-symbols-outlined">
                      @switch (formula.type) {
                        @case ('physical') { sports_martial_arts }
                        @case ('ranged') { keyboard_double_arrow_right }
                        @case ('magical') { auto_fix_high }
                      }
                    </span>
                    <div class="combat-type-card__content">
                      <span class="combat-type-card__label">{{ formula.label }}</span>
                      <span class="combat-type-card__desc">{{ formula.description }}</span>
                    </div>
                    <span class="combat-type-card__stats">{{ formula.primaryStat }} + {{ formula.secondaryStat }}</span>
                  </button>
                }
              } @else {
                @for (formula of defenseFormulas(); track formula.type) {
                  <button 
                    type="button"
                    class="combat-type-card"
                    [class.is-selected]="selectedAttackType() === formula.type"
                    (click)="selectAttackType(formula.type)"
                  >
                    <span class="combat-type-card__icon material-symbols-outlined">
                      @switch (formula.type) {
                        @case ('physical') { security }
                        @case ('ranged') { motion_blur }
                        @case ('magical') { shield_with_heart }
                      }
                    </span>
                    <div class="combat-type-card__content">
                      <span class="combat-type-card__label">{{ formula.label }}</span>
                      <span class="combat-type-card__desc">{{ formula.description }}</span>
                    </div>
                    <span class="combat-type-card__stats">{{ formula.primaryStat }} + {{ formula.secondaryStat }}</span>
                  </button>
                }
              }
            </div>
          </div>
        }

        <!-- Skills Section -->
        @if (skillOptions().length > 0) {
          <div class="skills-panel">
            <h3 class="section-title">
              <span class="material-symbols-outlined">school</span>
              Apply Skills
            </h3>
            <div class="skills-list">
              @for (skill of skillOptions(); track skill.id) {
                <button 
                  type="button"
                  class="skill-chip"
                  [class.is-selected]="skill.selected"
                  (click)="toggleSkill(skill.id)"
                >
                  <span class="skill-chip__name">{{ skill.name }}</span>
                  <span class="skill-chip__bonus">+{{ skill.level }}D20</span>
                </button>
              }
            </div>
          </div>
        }

        <!-- Bonus Modifiers -->
        <div class="adjustments-panel">
          <h3 class="section-title">
            <span class="material-symbols-outlined">tune</span>
            Adjustments
          </h3>
          <div class="adjustments-grid">
            <div class="adjustment">
              <label class="adjustment__label">Bonus Dice</label>
              <div class="adjustment__controls">
                <button 
                  type="button"
                  class="adjustment__btn"
                  (click)="adjustBonusDice(-1)" 
                  [disabled]="bonusDice() <= 0"
                  aria-label="Decrease bonus dice"
                >âˆ’</button>
                <span class="adjustment__value">{{ bonusDice() }}D20</span>
                <button 
                  type="button"
                  class="adjustment__btn"
                  (click)="adjustBonusDice(1)"
                  aria-label="Increase bonus dice"
                >+</button>
              </div>
            </div>
            <div class="adjustment">
              <label class="adjustment__label">Modifier</label>
              <div class="adjustment__controls">
                <button 
                  type="button"
                  class="adjustment__btn"
                  (click)="adjustBonusModifier(-1)"
                  aria-label="Decrease modifier"
                >âˆ’</button>
                <span class="adjustment__value">{{ formatModifier(bonusModifier()) }}</span>
                <button 
                  type="button"
                  class="adjustment__btn"
                  (click)="adjustBonusModifier(1)"
                  aria-label="Increase modifier"
                >+</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Results Panel -->
      <div class="results-panel">
        <!-- Calculation Preview -->
        @if (currentCalculation(); as calc) {
          <div class="calculation-card">
            <h3 class="section-title">Roll Summary</h3>
            
            <div class="calc-breakdown">
              <!-- CHANGED: Display all primary stats if multiple are selected -->
              @if (calc.primaryStats && calc.primaryStats.length > 1) {
                <!-- Multiple stats selected -->
                @for (stat of calc.primaryStats; track stat.abbr) {
                  <div class="calc-row">
                    <span class="calc-row__label">{{ stat.name }} ({{ stat.abbr }})</span>
                    <span class="calc-row__value">{{ stat.dice }}D20 {{ formatModifier(stat.mod) }}</span>
                  </div>
                }
              } @else if (calc.primaryStat; as primary) {
                <!-- Single stat (backward compatible) -->
                <div class="calc-row">
                  <span class="calc-row__label">{{ primary.name }} ({{ primary.abbr }})</span>
                  <span class="calc-row__value">{{ primary.dice }}D20 {{ formatModifier(primary.mod) }}</span>
                </div>
              }
              
              <!-- Secondary Stat (Combat only) -->
              @if (calc.secondaryStat; as secondary) {
                <div class="calc-row">
                  <span class="calc-row__label">{{ secondary.name }} ({{ secondary.abbr }})</span>
                  <span class="calc-row__value">{{ secondary.dice }}D20 {{ formatModifier(secondary.mod) }}</span>
                </div>
              }
              
              <!-- Skills -->
              @for (skill of calc.skills; track skill.id) {
                <div class="calc-row calc-row--secondary">
                  <span class="calc-row__label">{{ skill.name }}</span>
                  <span class="calc-row__value">+{{ skill.bonusDice }}D20</span>
                </div>
              }
              
              <!-- Bonus Dice -->
              @if (bonusDice() > 0) {
                <div class="calc-row calc-row--secondary">
                  <span class="calc-row__label">Bonus Dice</span>
                  <span class="calc-row__value">+{{ bonusDice() }}D20</span>
                </div>
              }
              
              <!-- Bonus Modifier -->
              @if (bonusModifier() !== 0) {
                <div class="calc-row calc-row--secondary">
                  <span class="calc-row__label">Bonus Modifier</span>
                  <span class="calc-row__value">{{ formatModifier(bonusModifier()) }}</span>
                </div>
              }
            </div>

            <!-- Total -->
            <div class="calc-total">
              <span class="calc-total__dice">{{ calc.dicePool.totalDice }}D20</span>
              <span class="calc-total__mod">{{ formatModifier(calc.dicePool.modifier) }}</span>
            </div>

            <!-- Roll Button -->
            <button 
              type="button"
              class="roll-btn"
              [class.is-rolling]="isRolling()"
              [disabled]="!canRoll() || isRolling()"
              (click)="roll()"
            >
              @if (isRolling()) {
                <span class="roll-btn__content">
                  <span class="roll-btn__dice-anim">ðŸŽ²</span>
                  Rolling...
                </span>
              } @else {
                <span class="roll-btn__content">
                  <span class="material-symbols-outlined">casino</span>
                  Roll {{ calc.dicePool.totalDice }}D20
                </span>
              }
            </button>
          </div>
        } @else {
          <!-- No Selection State -->
          <div class="empty-state">
            <span class="material-symbols-outlined">info</span>
            <!-- CHANGED: Updated message for multi-stat support -->
            <p>Select {{ mode() === 'simple' ? 'one or more stats' : 'a combat type' }} to calculate your dice pool</p>
          </div>
        }

        <!-- Roll Result -->
        @if (rollResult(); as result) {
          <div 
            class="roll-result"
            [class.roll-result--critical]="result.isCritical" 
            [class.roll-result--fumble]="result.isFumble"
          >
            @if (result.isCritical || result.isFumble) {
              <div class="roll-result__badge-row">
                @if (result.isCritical) {
                  <span class="roll-result__badge roll-result__badge--critical">Critical!</span>
                }
                @if (result.isFumble) {
                  <span class="roll-result__badge roll-result__badge--fumble">Fumble!</span>
                }
              </div>
            }
            
            <div class="roll-result__dice">
              @for (die of result.rolls; track $index) {
                <span 
                  class="die"
                  [class.die--nat20]="die === 20" 
                  [class.die--nat1]="die === 1"
                >{{ die }}</span>
              }
            </div>
            
            <div class="roll-result__calculation">
              <span class="roll-result__subtotal">{{ result.total }}</span>
              <span class="roll-result__modifier">{{ formatModifier(result.modifier) }}</span>
              <span class="roll-result__equals">=</span>
              <span class="roll-result__final">{{ result.finalResult }}</span>
            </div>
          </div>
        }

        <!-- Roll History -->
        @if (rollHistory().length > 0) {
          <div class="history-panel">
            <div class="history-panel__header">
              <h3 class="section-title">
                <span class="material-symbols-outlined">history</span>
                Roll History
              </h3>
              <button type="button" class="history-panel__clear" (click)="clearHistory()">
                Clear
              </button>
            </div>
            <div class="history-list">
              @for (entry of rollHistory(); track $index) {
                <div class="history-entry">
                  <span class="history-entry__desc">{{ entry.calculation.description }}</span>
                  <span class="history-entry__dice">{{ entry.calculation.dicePool.totalDice }}D20</span>
                  <span 
                    class="history-entry__result"
                    [class.history-entry__result--critical]="entry.result.isCritical"
                  >{{ entry.result.finalResult }}</span>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  } @else {
    <!-- No Character Selected -->
    <div class="empty-state empty-state--large">
      <span class="material-symbols-outlined">person_search</span>
      <p>Select a character to begin calculating dice pools</p>
    </div>
  }
</section>