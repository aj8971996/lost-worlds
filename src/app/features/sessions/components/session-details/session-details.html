<article class="session-detail">
  <!-- Loading State -->
  @if (loading()) {
    <div class="session-detail__loading">
      <div class="loading-spinner"></div>
      <p>Loading session notes...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="session-detail__error">
      <span class="error-icon material-symbols-outlined" aria-hidden="true">warning</span>
      <h1>Unable to Load Session</h1>
      <p>{{ error() }}</p>
      <a routerLink="/sessions" class="btn btn--primary">
        <span class="material-symbols-outlined" aria-hidden="true">arrow_back</span>
        <span>Back to Sessions</span>
      </a>
    </div>
  }

  <!-- Session Content -->
  @if (!loading() && !error() && session(); as s) {
    <!-- Hero Header -->
    <header class="session-hero">
      <div class="session-hero__backdrop"></div>
      <div class="session-hero__content">
        <nav class="session-hero__breadcrumb">
          <a routerLink="/" class="breadcrumb-link">Home</a>
          <span class="breadcrumb-separator">/</span>
          <a routerLink="/sessions" class="breadcrumb-link">Sessions</a>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">{{ sessionTitle() }}</span>
        </nav>

        <!-- Campaign Badge -->
        @if (s.campaign) {
          <div class="session-hero__campaign">
            <span class="campaign-tag">{{ s.campaign.name }}</span>
          </div>
        }

        <div class="session-hero__number">
          @if (s.sessionNumber === 0) {
            <span>Session Zero</span>
          } @else {
            <span>Session {{ s.sessionNumber }}</span>
          }
        </div>

        <h1 class="session-hero__title">{{ sessionTitle() }}</h1>

        <div class="session-hero__meta">
          <time class="meta-item" [attr.datetime]="s.sessionDate">
            <span class="meta-icon material-symbols-outlined" aria-hidden="true">calendar_month</span>
            {{ s.computed.formattedDate }}
          </time>
          
          <span class="meta-item">
            <span class="meta-icon material-symbols-outlined" aria-hidden="true">auto_awesome</span>
            +{{ s.experienceGained }} XP
          </span>

          @if (s.computed.wordCount > 0) {
            <span class="meta-item">
              <span class="meta-icon material-symbols-outlined" aria-hidden="true">description</span>
              {{ s.computed.wordCount }} words
            </span>
          }

          @if (s.computed.totalNpcs > 0) {
            <span class="meta-item">
              <span class="meta-icon material-symbols-outlined" aria-hidden="true">person</span>
              {{ s.computed.totalNpcs }} {{ s.computed.totalNpcs === 1 ? 'NPC' : 'NPCs' }}
              @if (s.computed.newNpcs > 0) {
                <span class="meta-new">({{ s.computed.newNpcs }} new)</span>
              }
            </span>
          }

          @if (s.computed.totalLocations > 0) {
            <span class="meta-item">
              <span class="meta-icon material-symbols-outlined" aria-hidden="true">location_on</span>
              {{ s.computed.totalLocations }} {{ s.computed.totalLocations === 1 ? 'location' : 'locations' }}
              @if (s.computed.newLocations > 0) {
                <span class="meta-new">({{ s.computed.newLocations }} new)</span>
              }
            </span>
          }
        </div>

        <!-- Players -->
        @if (s.players.length > 0) {
          <div class="session-hero__players">
            <span class="players-label">Adventurers:</span>
            <div class="player-avatars">
              @for (player of s.players; track trackByPlayerId($index, player)) {
                <a 
                  [routerLink]="['/characters', player.id]"
                  class="player-avatar"
                  [attr.title]="player.name"
                  [attr.aria-label]="'View ' + player.name + ' character sheet'"
                >
                  <span class="player-avatar__initials">{{ getPlayerInitials(player) }}</span>
                </a>
              }
            </div>
            <span class="players-names">
              @for (player of s.players; track player.id; let last = $last) {
                <a [routerLink]="['/characters', player.id]" class="player-name">
                  {{ player.name }}
                </a>{{ last ? '' : ', ' }}
              }
            </span>
          </div>
        }
      </div>
    </header>

    <!-- Main Content Area -->
    <div class="session-content">
      <!-- Session Narrative -->
      <div class="session-narrative">
        <!-- Preface Section -->
        @if (s.sessionNotesPreface) {
          <section class="narrative-section narrative-section--preface">
            <h2 class="narrative-section__title">
              <span class="section-icon material-symbols-outlined" aria-hidden="true">menu_book</span>
              Session Preface
            </h2>
            <div class="narrative-section__text">
              <p>{{ s.sessionNotesPreface }}</p>
            </div>
          </section>
        }

        <!-- Divider -->
        @if (s.sessionNotesPreface && s.sessionNotesCombat) {
          <div class="narrative-divider">
            <span class="divider-line"></span>
            <span class="divider-icon material-symbols-outlined" aria-hidden="true">sports_martial_arts</span>
            <span class="divider-line"></span>
          </div>
        }

        <!-- Combat Section -->
        @if (s.sessionNotesCombat) {
          <section class="narrative-section narrative-section--combat">
            <h2 class="narrative-section__title">
              <span class="section-icon material-symbols-outlined" aria-hidden="true">swords</span>
              Session Conflict
            </h2>
            <div class="narrative-section__text">
              <p>{{ s.sessionNotesCombat }}</p>
            </div>
          </section>
        }

        <!-- Divider -->
        @if (s.sessionNotesCombat && s.sessionNotesEnd) {
          <div class="narrative-divider">
            <span class="divider-line"></span>
            <span class="divider-icon material-symbols-outlined" aria-hidden="true">flag</span>
            <span class="divider-line"></span>
          </div>
        }

        <!-- End Section -->
        @if (s.sessionNotesEnd) {
          <section class="narrative-section narrative-section--end">
            <h2 class="narrative-section__title">
              <span class="section-icon material-symbols-outlined" aria-hidden="true">auto_stories</span>
              Session Closing
            </h2>
            <div class="narrative-section__text">
              <p>{{ s.sessionNotesEnd }}</p>
            </div>
          </section>
        }

        <!-- Empty State if no content -->
        @if (!s.sessionNotesPreface && !s.sessionNotesCombat && !s.sessionNotesEnd) {
          <div class="narrative-empty">
            <span class="empty-icon material-symbols-outlined" aria-hidden="true">history_edu</span>
            <p>The chronicles of this session have yet to be written...</p>
          </div>
        }
      </div>

      <!-- Sidebar: NPCs and Locations -->
      <aside class="session-sidebar">
        <!-- NPCs Met -->
        @if (s.npcsMet && s.npcsMet.length > 0) {
          <section class="sidebar-section sidebar-section--npcs">
            <h3 class="sidebar-section__title">
              <span class="section-icon material-symbols-outlined" aria-hidden="true">groups</span>
              NPCs Met
            </h3>
            <ul class="npc-list">
              @for (npc of s.npcsMet; track npc.id) {
                <li class="npc-card" [class.npc-card--new]="npc.firstAppearance">
                  <div class="npc-card__header">
                    <span class="npc-card__name">{{ npc.name }}</span>
                    @if (npc.firstAppearance) {
                      <span class="npc-card__badge npc-card__badge--new">New</span>
                    }
                    @if (npc.disposition && npc.disposition !== 'unknown') {
                      <span 
                        class="npc-card__badge" 
                        [class.npc-card__badge--friendly]="npc.disposition === 'friendly'"
                        [class.npc-card__badge--hostile]="npc.disposition === 'hostile'"
                        [class.npc-card__badge--neutral]="npc.disposition === 'neutral'"
                      >
                        {{ getDispositionLabel(npc.disposition) }}
                      </span>
                    }
                  </div>
                  @if (npc.affiliation) {
                    <span class="npc-card__affiliation">{{ npc.affiliation }}</span>
                  }
                  @if (npc.description) {
                    <p class="npc-card__description">{{ npc.description }}</p>
                  }
                </li>
              }
            </ul>
          </section>
        }

        <!-- Locations Visited -->
        @if (s.locationsVisited && s.locationsVisited.length > 0) {
          <section class="sidebar-section sidebar-section--locations">
            <h3 class="sidebar-section__title">
              <span class="section-icon material-symbols-outlined" aria-hidden="true">map</span>
              Locations Visited
            </h3>
            <ul class="location-list">
              @for (location of s.locationsVisited; track location.id) {
                <li class="location-card" [class.location-card--new]="location.firstVisit">
                  <div class="location-card__header">
                    <span class="location-card__name">{{ location.name }}</span>
                    @if (location.firstVisit) {
                      <span class="location-card__badge location-card__badge--new">New</span>
                    }
                  </div>
                  @if (location.region) {
                    <span class="location-card__region">
                      <span class="region-icon material-symbols-outlined" aria-hidden="true">place</span>
                      {{ location.region }}
                    </span>
                  }
                  @if (location.type) {
                    <span class="location-card__type">{{ getLocationTypeLabel(location.type) }}</span>
                  }
                  @if (location.description) {
                    <p class="location-card__description">{{ location.description }}</p>
                  }
                </li>
              }
            </ul>
          </section>
        }

        <!-- Items Acquired -->
        @if (s.itemsAcquired && s.itemsAcquired.length > 0) {
          <section class="sidebar-section sidebar-section--items">
            <h3 class="sidebar-section__title">
              <span class="section-icon material-symbols-outlined" aria-hidden="true">inventory_2</span>
              Items Acquired
            </h3>
            <ul class="item-list">
              @for (item of s.itemsAcquired; track item) {
                <li class="item-tag">{{ item }}</li>
              }
            </ul>
          </section>
        }
      </aside>
    </div>

    <!-- Session Footer with Navigation -->
    <footer class="session-footer">
      <div class="session-footer__nav">
        @if (previousSessionId()) {
          <a 
            [routerLink]="['/sessions', previousSessionId()]" 
            class="nav-link nav-link--prev"
          >
            <span class="nav-link__arrow material-symbols-outlined" aria-hidden="true">chevron_left</span>
            <span class="nav-link__text">Previous Session</span>
          </a>
        } @else {
          <span class="nav-link nav-link--disabled">
            <span class="nav-link__arrow material-symbols-outlined" aria-hidden="true">chevron_left</span>
            <span class="nav-link__text">Previous Session</span>
          </span>
        }

        <a routerLink="/sessions" class="nav-link nav-link--all">
          <span class="nav-link__text">All Sessions</span>
        </a>

        @if (nextSessionId()) {
          <a 
            [routerLink]="['/sessions', nextSessionId()]" 
            class="nav-link nav-link--next"
          >
            <span class="nav-link__text">Next Session</span>
            <span class="nav-link__arrow material-symbols-outlined" aria-hidden="true">chevron_right</span>
          </a>
        } @else {
          <span class="nav-link nav-link--disabled">
            <span class="nav-link__text">Next Session</span>
            <span class="nav-link__arrow material-symbols-outlined" aria-hidden="true">chevron_right</span>
          </span>
        }
      </div>

      <!-- XP Reward Banner -->
      <div class="session-footer__xp">
        <div class="xp-reward">
          <span class="xp-reward__label">Session Reward</span>
          <span class="xp-reward__value">+{{ s.experienceGained }} XP</span>
        </div>
      </div>
    </footer>
  }
</article>