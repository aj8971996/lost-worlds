<div class="equipment-page">
  <!-- Page Header -->
  <header class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <span class="material-symbols-outlined">inventory_2</span>
        Equipment Armory
      </h1>
      <p class="page-subtitle">Browse and search all weapons, armor, and items in the Lost Worlds</p>
    </div>
    
    <!-- Search Bar -->
    <div class="search-container">
      <span class="material-symbols-outlined search-icon">search</span>
      <input 
        type="text" 
        class="search-input"
        placeholder="Search equipment by name, effect, or description..."
        [ngModel]="filters().search"
        (ngModelChange)="updateSearch($event)"
      />
      @if (filters().search) {
        <button class="search-clear" (click)="updateSearch('')">
          <span class="material-symbols-outlined">close</span>
        </button>
      }
    </div>
  </header>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <div class="loading-spinner">
        <span class="material-symbols-outlined">progress_activity</span>
      </div>
      <p>Loading equipment...</p>
    </div>
  }

  <!-- Error State -->
  @else if (error()) {
    <div class="error-state">
      <span class="material-symbols-outlined">error</span>
      <h2>Failed to Load</h2>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="ngOnInit()">Try Again</button>
    </div>
  }

  <!-- Main Content -->
  @else {
    <div class="content-layout">
      <!-- Mobile Filter Toggle Button -->
      <button class="mobile-filter-toggle" (click)="openMobileFilters()">
        <span class="material-symbols-outlined">filter_list</span>
        <span>Filters</span>
        @if (activeFilterCount() > 0) {
          <span class="filter-badge">{{ activeFilterCount() }}</span>
        }
      </button>

      <!-- Mobile Filter Overlay -->
      <div 
        class="filters-overlay" 
        [class.is-visible]="isMobileFiltersOpen()"
        (click)="closeMobileFilters()"
      ></div>

      <!-- Sidebar Filters -->
      <aside class="filters-sidebar" [class.is-open]="isMobileFiltersOpen()">
        <!-- Mobile Header -->
        <div class="filters-mobile-header">
          <span class="filters-mobile-title">
            <span class="material-symbols-outlined">filter_list</span>
            Filters
          </span>
          <button class="filters-close-btn" (click)="closeMobileFilters()">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>

        <!-- Filter Content (scrollable area) -->
        <div class="filters-scroll-area">
          <!-- Desktop Header -->
          <div class="filters-desktop-header">
            <div class="filters-title">
              <span class="material-symbols-outlined">filter_list</span>
              <span>Filters</span>
            </div>
            @if (activeFilterCount() > 0) {
              <button class="clear-all-btn" (click)="clearAllFilters()">
                Clear All ({{ activeFilterCount() }})
              </button>
            }
          </div>

          <!-- Equipment Category Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('categories')">
              <span class="filter-section__title">Category</span>
              <span class="material-symbols-outlined filter-section__chevron" 
                    [class.expanded]="isSectionExpanded('categories')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('categories')) {
              <div class="filter-section__content">
                @for (cat of mainCategories; track cat.id) {
                  <label class="filter-checkbox" [style.--category-color]="cat.color">
                    <input 
                      type="checkbox" 
                      [checked]="isFilterActive('categories', cat.id)"
                      (change)="toggleFilter('categories', cat.id)"
                    />
                    <span class="filter-checkbox__mark"></span>
                    <span class="filter-checkbox__icon material-symbols-outlined">{{ cat.icon }}</span>
                    <span class="filter-checkbox__label">{{ cat.name }}</span>
                  </label>
                }
              </div>
            }
          </div>

          <!-- Weapon Category Filter (Earthly/Cosmic) -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('weaponCategories')">
              <span class="filter-section__title">Weapon Origin</span>
              <span class="material-symbols-outlined filter-section__chevron"
                    [class.expanded]="isSectionExpanded('weaponCategories')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('weaponCategories')) {
              <div class="filter-section__content">
                @for (wc of weaponCategories; track wc.id) {
                  <label class="filter-checkbox" [style.--category-color]="wc.color">
                    <input 
                      type="checkbox"
                      [checked]="isFilterActive('weaponCategories', wc.id)"
                      (change)="toggleFilter('weaponCategories', wc.id)"
                    />
                    <span class="filter-checkbox__mark"></span>
                    <span class="filter-checkbox__label">{{ wc.name }}</span>
                  </label>
                }
              </div>
            }
          </div>

          <!-- Weapon Types Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('weaponTypes')">
              <span class="filter-section__title">Weapon Type</span>
              <span class="material-symbols-outlined filter-section__chevron"
                    [class.expanded]="isSectionExpanded('weaponTypes')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('weaponTypes')) {
              <div class="filter-section__content">
                @for (group of weaponTypeGroups; track group.group) {
                  <div class="filter-group">
                    <span class="filter-group__label">{{ group.group }}</span>
                    @for (type of group.types; track type.id) {
                      <label class="filter-checkbox filter-checkbox--nested">
                        <input 
                          type="checkbox"
                          [checked]="isFilterActive('weaponTypes', type.id)"
                          (change)="toggleFilter('weaponTypes', type.id)"
                        />
                        <span class="filter-checkbox__mark"></span>
                        <span class="filter-checkbox__label">{{ type.name }}</span>
                      </label>
                    }
                  </div>
                }
              </div>
            }
          </div>

          <!-- Cosmic Source Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('cosmicSources')">
              <span class="filter-section__title">Cosmic Source</span>
              <span class="material-symbols-outlined filter-section__chevron"
                    [class.expanded]="isSectionExpanded('cosmicSources')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('cosmicSources')) {
              <div class="filter-section__content">
                @for (source of cosmicSources; track source.id) {
                  <label class="filter-checkbox" [style.--category-color]="source.color">
                    <input 
                      type="checkbox"
                      [checked]="isFilterActive('cosmicSources', source.id)"
                      (change)="toggleFilter('cosmicSources', source.id)"
                    />
                    <span class="filter-checkbox__mark"></span>
                    <span class="filter-checkbox__label">{{ source.name }}</span>
                  </label>
                }
              </div>
            }
          </div>

          <!-- Armor Set Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('armorSets')">
              <span class="filter-section__title">Armor Set</span>
              <span class="material-symbols-outlined filter-section__chevron"
                    [class.expanded]="isSectionExpanded('armorSets')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('armorSets')) {
              <div class="filter-section__content">
                @for (set of armorSets; track set.id) {
                  <label class="filter-checkbox" [style.--category-color]="set.color">
                    <input 
                      type="checkbox"
                      [checked]="isFilterActive('armorSets', set.id)"
                      (change)="toggleFilter('armorSets', set.id)"
                    />
                    <span class="filter-checkbox__mark"></span>
                    <span class="filter-checkbox__label">{{ set.name }}</span>
                  </label>
                }
              </div>
            }
          </div>

          <!-- Armor Material Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('armorMaterials')">
              <span class="filter-section__title">Armor Material</span>
              <span class="material-symbols-outlined filter-section__chevron"
                    [class.expanded]="isSectionExpanded('armorMaterials')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('armorMaterials')) {
              <div class="filter-section__content">
                @for (mat of armorMaterials; track mat.id) {
                  <label class="filter-checkbox">
                    <input 
                      type="checkbox"
                      [checked]="isFilterActive('armorMaterials', mat.id)"
                      (change)="toggleFilter('armorMaterials', mat.id)"
                    />
                    <span class="filter-checkbox__mark"></span>
                    <span class="filter-checkbox__label">{{ mat.name }}</span>
                  </label>
                }
              </div>
            }
          </div>

          <!-- Armor Slot Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('armorSlots')">
              <span class="filter-section__title">Armor Slot</span>
              <span class="material-symbols-outlined filter-section__chevron"
                    [class.expanded]="isSectionExpanded('armorSlots')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('armorSlots')) {
              <div class="filter-section__content filter-section__content--grid">
                @for (slot of armorSlots; track slot.id) {
                  <label class="filter-checkbox filter-checkbox--compact">
                    <input 
                      type="checkbox"
                      [checked]="isFilterActive('armorSlots', slot.id)"
                      (change)="toggleFilter('armorSlots', slot.id)"
                    />
                    <span class="filter-checkbox__mark"></span>
                    <span class="filter-checkbox__label">{{ slot.name }}</span>
                  </label>
                }
              </div>
            }
          </div>

          <!-- Item Category Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('itemCategories')">
              <span class="filter-section__title">Item Type</span>
              <span class="material-symbols-outlined filter-section__chevron"
                    [class.expanded]="isSectionExpanded('itemCategories')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('itemCategories')) {
              <div class="filter-section__content">
                @for (cat of itemCategories; track cat.id) {
                  <label class="filter-checkbox">
                    <input 
                      type="checkbox"
                      [checked]="isFilterActive('itemCategories', cat.id)"
                      (change)="toggleFilter('itemCategories', cat.id)"
                    />
                    <span class="filter-checkbox__mark"></span>
                    <span class="filter-checkbox__label">{{ cat.name }}</span>
                  </label>
                }
              </div>
            }
          </div>

          <!-- Consumable Type Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('consumableTypes')">
              <span class="filter-section__title">Consumable Type</span>
              <span class="material-symbols-outlined filter-section__chevron"
                    [class.expanded]="isSectionExpanded('consumableTypes')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('consumableTypes')) {
              <div class="filter-section__content">
                @for (type of consumableTypes; track type.id) {
                  <label class="filter-checkbox">
                    <input 
                      type="checkbox"
                      [checked]="isFilterActive('consumableTypes', type.id)"
                      (change)="toggleFilter('consumableTypes', type.id)"
                    />
                    <span class="filter-checkbox__mark"></span>
                    <span class="filter-checkbox__label">{{ type.name }}</span>
                  </label>
                }
              </div>
            }
          </div>
        </div>

        <!-- Mobile Apply Button -->
        <div class="filters-mobile-footer">
          <button class="btn btn-primary" (click)="closeMobileFilters()">
            Show {{ filteredEquipment().length }} Results
          </button>
        </div>
      </aside>

      <!-- Main Equipment List -->
      <main class="equipment-list">
        <!-- Results Count -->
        <div class="results-header">
          <span class="results-count">
            {{ filteredEquipment().length }} item{{ filteredEquipment().length !== 1 ? 's' : '' }} found
          </span>
        </div>

        <!-- Equipment Items -->
        @if (filteredEquipment().length > 0) {
          <div class="equipment-items">
            @for (item of filteredEquipment(); track item.id) {
              <article 
                class="equipment-row"
                [class.is-expanded]="isEquipmentExpanded(item.id)"
                [class.is-cosmic]="item.weaponCategory === 'cosmic'"
                [attr.data-category]="item.category"
              >
                <!-- Row Header (Always visible) -->
                <button 
                  class="equipment-row__header"
                  (click)="toggleEquipmentExpanded(item.id)"
                  [attr.aria-expanded]="isEquipmentExpanded(item.id)"
                >
                  <!-- Category Icon -->
                  <span 
                    class="equipment-row__category-icon material-symbols-outlined"
                    [style.color]="getCategoryColor(item.category)"
                  >
                    {{ getCategoryIcon(item.category) }}
                  </span>

                  <!-- Name & Quick Info -->
                  <div class="equipment-row__info">
                    <span class="equipment-row__name">{{ item.name }}</span>
                    <span class="equipment-row__preview">{{ getPreviewText(item) }}</span>
                  </div>

                  <!-- Tags -->
                  <div class="equipment-row__tags">
                    @if (item.category === 'weapon' && item.weaponType) {
                      <span class="equipment-tag equipment-tag--type">
                        {{ getWeaponTypeDisplay(item.weaponType) }}
                      </span>
                    }
                    @if (item.category === 'weapon' && item.weaponCategory === 'cosmic' && item.cosmicSource) {
                      <span 
                        class="equipment-tag equipment-tag--cosmic"
                        [style.--cosmic-color]="getCosmicSourceColor(item.cosmicSource)"
                      >
                        {{ getCosmicSourceShortName(item.cosmicSource) }}
                      </span>
                    }
                    @if (item.category === 'armor' && item.armorSet) {
                      <span 
                        class="equipment-tag equipment-tag--set"
                        [style.--set-color]="getArmorSetColor(item.armorSet)"
                      >
                        {{ formatSetName(item.armorSet) }}
                      </span>
                    }
                    @if (item.category === 'item' && item.consumableType) {
                      <span class="equipment-tag equipment-tag--consumable">
                        {{ formatConsumableType(item.consumableType) }}
                      </span>
                    }
                    @if (item.cost) {
                      <span class="equipment-tag equipment-tag--cost">
                        <span class="material-symbols-outlined">payments</span>
                        {{ item.cost }}
                      </span>
                    }
                  </div>

                  <!-- Expand Chevron -->
                  <span class="equipment-row__chevron material-symbols-outlined">
                    expand_more
                  </span>
                </button>

                <!-- Expanded Details -->
                <div class="equipment-row__details">
                  <!-- Stats Grid -->
                  <div class="equipment-details__stats-grid">
                    @if (item.category === 'weapon') {
                      <div class="stat-item">
                        <span class="material-symbols-outlined">swords</span>
                        <span class="stat-item__label">Damage</span>
                        <span class="stat-item__value">{{ item.damage }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="material-symbols-outlined">straighten</span>
                        <span class="stat-item__label">Range</span>
                        <span class="stat-item__value">{{ item.range }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="material-symbols-outlined">schedule</span>
                        <span class="stat-item__label">AP Cost</span>
                        <span class="stat-item__value">{{ item.apCost }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="material-symbols-outlined">favorite</span>
                        <span class="stat-item__label">HP</span>
                        <span class="stat-item__value">{{ item.baseHp }}</span>
                      </div>
                    }
                    @if (item.category === 'armor') {
                      <div class="stat-item">
                        <span class="material-symbols-outlined">shield</span>
                        <span class="stat-item__label">DR</span>
                        <span class="stat-item__value">{{ item.damageReduction || '-' }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="material-symbols-outlined">favorite</span>
                        <span class="stat-item__label">HP</span>
                        <span class="stat-item__value">{{ item.baseHp }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="material-symbols-outlined">person</span>
                        <span class="stat-item__label">Slot</span>
                        <span class="stat-item__value">{{ formatSlotName(item.armorSlot!) }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="material-symbols-outlined">layers</span>
                        <span class="stat-item__label">Material</span>
                        <span class="stat-item__value">{{ getArmorMaterialDisplay(item.armorMaterial!) }}</span>
                      </div>
                    }
                    @if (item.category === 'item') {
                      @if (item.cost) {
                        <div class="stat-item">
                          <span class="material-symbols-outlined">payments</span>
                          <span class="stat-item__label">Cost</span>
                          <span class="stat-item__value">{{ item.cost }}</span>
                        </div>
                      }
                      <div class="stat-item">
                        <span class="material-symbols-outlined">category</span>
                        <span class="stat-item__label">Type</span>
                        <span class="stat-item__value">{{ item.itemCategory }}</span>
                      </div>
                      @if (item.stackable !== undefined) {
                        <div class="stat-item">
                          <span class="material-symbols-outlined">stacks</span>
                          <span class="stat-item__label">Stackable</span>
                          <span class="stat-item__value">{{ item.stackable ? 'Yes' : 'No' }}</span>
                        </div>
                      }
                    }
                    @if (item.category === 'accessory') {
                      <div class="stat-item">
                        <span class="material-symbols-outlined">favorite</span>
                        <span class="stat-item__label">HP</span>
                        <span class="stat-item__value">{{ item.baseHp }}</span>
                      </div>
                      @if (item.cost) {
                        <div class="stat-item">
                          <span class="material-symbols-outlined">payments</span>
                          <span class="stat-item__label">Cost</span>
                          <span class="stat-item__value">{{ item.cost }}</span>
                        </div>
                      }
                    }
                  </div>

                  <!-- Special Effect -->
                  @if (item.special || item.armorSpecial || item.effect || item.accessoryEffect) {
                    <div class="equipment-details__section">
                      <h4 class="equipment-details__section-title">
                        @if (item.category === 'weapon') { Special }
                        @else if (item.category === 'armor') { Ability }
                        @else { Effect }
                      </h4>
                      <p class="equipment-details__text">
                        {{ item.special || item.armorSpecial || item.effect || item.accessoryEffect }}
                      </p>
                    </div>
                  }

                  <!-- Description -->
                  @if (item.description) {
                    <div class="equipment-details__section">
                      <h4 class="equipment-details__section-title">Description</h4>
                      <p class="equipment-details__description">{{ item.description }}</p>
                    </div>
                  }

                  <!-- Stat Bonuses (for armor) -->
                  @if (item.statBonus && Object.keys(item.statBonus).length > 0) {
                    <div class="equipment-details__section">
                      <h4 class="equipment-details__section-title">Stat Bonuses</h4>
                      <div class="stat-bonuses">
                        @for (entry of item.statBonus | keyvalue; track entry.key) {
                          <span class="stat-bonus">
                            +{{ entry.value }} {{ entry.key }}
                          </span>
                        }
                      </div>
                    </div>
                  }

                  <!-- Cosmic Source Info -->
                  @if (item.cosmicSource) {
                    <div class="equipment-details__section equipment-details__cosmic">
                      <span class="material-symbols-outlined">auto_awesome</span>
                      <p>{{ getCosmicSourceDisplay(item.cosmicSource) }}</p>
                    </div>
                  }

                  <!-- Notes -->
                  @if (item.notes) {
                    <div class="equipment-details__section equipment-details__notes">
                      <span class="material-symbols-outlined">info</span>
                      <p>{{ item.notes }}</p>
                    </div>
                  }

                  <!-- Footer Tags -->
                  <div class="equipment-details__footer">
                    <div class="equipment-tags">
                      @if (item.category === 'weapon') {
                        <span class="equipment-tag-full equipment-tag-full--category">
                          <span class="material-symbols-outlined">{{ getCategoryIcon(item.category) }}</span>
                          Weapon
                        </span>
                        @if (item.weaponCategory === 'cosmic') {
                          <span class="equipment-tag-full equipment-tag-full--cosmic">Cosmic</span>
                        } @else {
                          <span class="equipment-tag-full equipment-tag-full--earthly">Earthly</span>
                        }
                      }
                      @if (item.category === 'armor') {
                        <span class="equipment-tag-full equipment-tag-full--category">
                          <span class="material-symbols-outlined">{{ getCategoryIcon(item.category) }}</span>
                          Armor
                        </span>
                        @if (item.armorSet) {
                          <span class="equipment-tag-full equipment-tag-full--set">{{ formatSetName(item.armorSet) }} Set</span>
                        }
                      }
                      @if (item.category === 'item') {
                        <span class="equipment-tag-full equipment-tag-full--category">
                          <span class="material-symbols-outlined">{{ getCategoryIcon(item.category) }}</span>
                          Item
                        </span>
                      }
                      @if (item.category === 'accessory') {
                        <span class="equipment-tag-full equipment-tag-full--category">
                          <span class="material-symbols-outlined">{{ getCategoryIcon(item.category) }}</span>
                          Accessory
                        </span>
                      }
                    </div>
                    @if (item.levelRequirement) {
                      <span class="level-requirement">
                        Level {{ item.levelRequirement }}+
                      </span>
                    }
                  </div>
                </div>
              </article>
            }
          </div>
        } @else {
          <div class="no-results">
            <span class="material-symbols-outlined">search_off</span>
            <h3>No Equipment Found</h3>
            <p>Try adjusting your search or filters</p>
            <button class="btn btn-secondary" (click)="clearAllFilters()">Clear All Filters</button>
          </div>
        }
      </main>
    </div>
  }
</div>