<div class="abilities-page">
  <!-- Page Header -->
  <header class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <span class="material-symbols-outlined">local_library</span>
        Lost Worlds Library
      </h1>
      <p class="page-subtitle">Browse and search all abilities across schools of magic</p>
    </div>
    
    <!-- Search Bar -->
    <div class="search-container">
      <span class="material-symbols-outlined search-icon">search</span>
      <input 
        type="text" 
        class="search-input"
        placeholder="Search abilities by name, description, or effect..."
        [ngModel]="filters().search"
        (ngModelChange)="updateSearch($event)"
      />
      @if (filters().search) {
        <button class="search-clear" (click)="updateSearch('')">
          <span class="material-symbols-outlined">close</span>
        </button>
      }
    </div>
  </header>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <div class="loading-spinner">
        <span class="material-symbols-outlined">progress_activity</span>
      </div>
      <p>Loading abilities...</p>
    </div>
  }

  <!-- Error State -->
  @else if (error()) {
    <div class="error-state">
      <span class="material-symbols-outlined">error</span>
      <h2>Failed to Load</h2>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="ngOnInit()">Try Again</button>
    </div>
  }

  <!-- Main Content -->
  @else {
    <div class="content-layout">
      <!-- Mobile Filter Toggle Button -->
      <button class="mobile-filter-toggle" (click)="openMobileFilters()">
        <span class="material-symbols-outlined">filter_list</span>
        <span>Filters</span>
        @if (activeFilterCount() > 0) {
          <span class="filter-badge">{{ activeFilterCount() }}</span>
        }
      </button>

      <!-- Mobile Filter Overlay -->
      <div 
        class="filters-overlay" 
        [class.is-visible]="isMobileFiltersOpen()"
        (click)="closeMobileFilters()"
      ></div>

      <!-- Sidebar Filters -->
      <aside class="filters-sidebar" [class.is-open]="isMobileFiltersOpen()">
        <!-- Mobile Header -->
        <div class="filters-mobile-header">
          <span class="filters-mobile-title">
            <span class="material-symbols-outlined">filter_list</span>
            Filters
          </span>
          <button class="filters-close-btn" (click)="closeMobileFilters()">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>

        <!-- Filter Content (scrollable area) -->
        <div class="filters-scroll-area">
          <!-- Desktop Header -->
          <div class="filters-desktop-header">
            <div class="filters-title">
              <span class="material-symbols-outlined">filter_list</span>
              <span>Filters</span>
            </div>
            @if (activeFilterCount() > 0) {
              <button class="clear-all-btn" (click)="clearAllFilters()">
                Clear All ({{ activeFilterCount() }})
              </button>
            }
          </div>

          <!-- Magic College Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('colleges')">
              <span class="filter-section__title">Magic College</span>
              <span class="material-symbols-outlined filter-section__chevron" 
                    [class.expanded]="isSectionExpanded('colleges')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('colleges')) {
              <div class="filter-section__content">
                @for (college of colleges; track college.id) {
                  <label class="filter-checkbox" [style.--college-color]="college.color">
                    <input 
                      type="checkbox" 
                      [checked]="isFilterActive('colleges', college.id)"
                      (change)="toggleFilter('colleges', college.id)"
                    />
                    <span class="filter-checkbox__mark"></span>
                    <span class="filter-checkbox__label">{{ college.name }}</span>
                  </label>
                }
              </div>
            }
          </div>

          <!-- Schools Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('schools')">
              <span class="filter-section__title">Schools</span>
              <span class="material-symbols-outlined filter-section__chevron"
                    [class.expanded]="isSectionExpanded('schools')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('schools')) {
              <div class="filter-section__content">
                @for (college of colleges; track college.id) {
                  <div class="school-group">
                    <span class="school-group__label" [style.color]="college.color">{{ college.name }}</span>
                    @for (school of schoolsByCollege[college.id]; track school.id) {
                      <label class="filter-checkbox filter-checkbox--nested">
                        <input 
                          type="checkbox"
                          [checked]="isFilterActive('schools', school.id)"
                          (change)="toggleFilter('schools', school.id)"
                        />
                        <span class="filter-checkbox__mark"></span>
                        <span class="filter-checkbox__label">{{ school.name }}</span>
                      </label>
                    }
                  </div>
                }
              </div>
            }
          </div>

          <!-- Stats Used Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('stats')">
              <span class="filter-section__title">Stats Used</span>
              <span class="material-symbols-outlined filter-section__chevron"
                    [class.expanded]="isSectionExpanded('stats')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('stats')) {
              <div class="filter-section__content filter-section__content--grid">
                @for (stat of statOptions; track stat) {
                  <label class="filter-checkbox filter-checkbox--compact">
                    <input 
                      type="checkbox"
                      [checked]="isFilterActive('stats', stat)"
                      (change)="toggleFilter('stats', stat)"
                    />
                    <span class="filter-checkbox__mark"></span>
                    <span class="filter-checkbox__label">{{ stat }}</span>
                  </label>
                }
              </div>
            }
          </div>

          <!-- Ability Types Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('abilityTypes')">
              <span class="filter-section__title">Ability Type</span>
              <span class="material-symbols-outlined filter-section__chevron"
                    [class.expanded]="isSectionExpanded('abilityTypes')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('abilityTypes')) {
              <div class="filter-section__content">
                @for (type of abilityTypes; track type.id) {
                  <label class="filter-checkbox">
                    <input 
                      type="checkbox"
                      [checked]="isFilterActive('abilityTypes', type.id)"
                      (change)="toggleFilter('abilityTypes', type.id)"
                    />
                    <span class="filter-checkbox__mark"></span>
                    <span class="filter-checkbox__label">{{ type.name }}</span>
                  </label>
                }
              </div>
            }
          </div>

          <!-- AP Cost Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('apCost')">
              <span class="filter-section__title">AP Cost</span>
              <span class="material-symbols-outlined filter-section__chevron"
                    [class.expanded]="isSectionExpanded('apCost')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('apCost')) {
              <div class="filter-section__content">
                @for (cost of apCostOptions; track cost.id) {
                  <label class="filter-checkbox">
                    <input 
                      type="checkbox"
                      [checked]="isFilterActive('apCost', cost.id)"
                      (change)="toggleFilter('apCost', cost.id)"
                    />
                    <span class="filter-checkbox__mark"></span>
                    <span class="filter-checkbox__label">{{ cost.name }}</span>
                  </label>
                }
              </div>
            }
          </div>

          <!-- Source Type Filter -->
          <div class="filter-section">
            <button class="filter-section__header" (click)="toggleSection('sourceTypes')">
              <span class="filter-section__title">Source Type</span>
              <span class="material-symbols-outlined filter-section__chevron"
                    [class.expanded]="isSectionExpanded('sourceTypes')">
                expand_more
              </span>
            </button>
            @if (isSectionExpanded('sourceTypes')) {
              <div class="filter-section__content">
                @for (source of sourceTypes; track source.id) {
                  <label class="filter-checkbox">
                    <input 
                      type="checkbox"
                      [checked]="isFilterActive('sourceTypes', source.id)"
                      (change)="toggleFilter('sourceTypes', source.id)"
                    />
                    <span class="filter-checkbox__mark"></span>
                    <span class="filter-checkbox__label">{{ source.name }}</span>
                  </label>
                }
              </div>
            }
          </div>
        </div>
      </aside>

      <!-- Results Area -->
      <main class="results-area">
        <!-- Results Header -->
        <div class="results-header">
          <span class="results-count">
            Showing <strong>{{ filteredAbilities().length }}</strong> 
            of {{ abilities().length }} abilities
          </span>
          
          <!-- Active Filters Pills -->
          @if (activeFilterCount() > 0) {
            <div class="active-filters">
              @for (college of filters().colleges; track college) {
                <button class="filter-pill filter-pill--college" 
                        [style.--pill-color]="getCollegeColor(college)"
                        (click)="toggleFilter('colleges', college)">
                  {{ college }}
                  <span class="material-symbols-outlined">close</span>
                </button>
              }
              @for (school of filters().schools; track school) {
                <button class="filter-pill" (click)="toggleFilter('schools', school)">
                  {{ school }}
                  <span class="material-symbols-outlined">close</span>
                </button>
              }
              @for (stat of filters().stats; track stat) {
                <button class="filter-pill filter-pill--stat" (click)="toggleFilter('stats', stat)">
                  {{ stat }}
                  <span class="material-symbols-outlined">close</span>
                </button>
              }
              @for (sourceType of filters().sourceTypes; track sourceType) {
                <button class="filter-pill" (click)="toggleFilter('sourceTypes', sourceType)">
                  {{ sourceType }}
                  <span class="material-symbols-outlined">close</span>
                </button>
              }
              @for (abilityType of filters().abilityTypes; track abilityType) {
                <button class="filter-pill" (click)="toggleFilter('abilityTypes', abilityType)">
                  {{ abilityType }}
                  <span class="material-symbols-outlined">close</span>
                </button>
              }
              @for (cost of filters().apCost; track cost) {
                <button class="filter-pill" (click)="toggleFilter('apCost', cost)">
                  {{ cost }} AP
                  <span class="material-symbols-outlined">close</span>
                </button>
              }
            </div>
          }
        </div>

        <!-- Abilities List -->
        @if (filteredAbilities().length > 0) {
          <div class="abilities-list">
            @for (ability of filteredAbilities(); track ability.id) {
              <article 
                class="ability-row" 
                [attr.data-college]="getAbilityCollege(ability)"
                [class.is-expanded]="isAbilityExpanded(ability.id)"
              >
                <!-- Row Header (always visible) -->
                <button 
                  class="ability-row__header"
                  (click)="toggleAbilityExpanded(ability.id)"
                  [attr.aria-expanded]="isAbilityExpanded(ability.id)"
                >
                  <!-- College indicator bar -->
                  <div class="ability-row__college-bar"></div>
                  
                  <!-- Name + Focus -->
                  <div class="ability-row__primary">
                    <h3 class="ability-row__name">{{ ability.name }}</h3>
                    <span class="ability-row__focus">{{ formatFocusName(ability.source | abilityFocus) }}</span>
                  </div>
                  
                  <!-- Level badge -->
                  <div class="ability-row__level" [title]="'Required Focus Level'">
                    <span class="ability-row__level-value">{{ getRequiredLevel(ability) }}</span>
                    <span class="ability-row__level-label">Lv</span>
                  </div>
                  
                  <!-- Key output -->
                  <div class="ability-row__output">
                    @if (getDamageDisplay(ability)) {
                      <div class="output-badge output-badge--damage" [attr.data-damage-type]="getDamageType(ability)">
                        <span class="material-symbols-outlined">swords</span>
                        <span class="output-badge__value">{{ getDamageDisplay(ability) }}</span>
                        @if (getDamageType(ability)) {
                          <span class="output-badge__type">{{ getDamageType(ability) }}</span>
                        }
                      </div>
                    } @else if (getHealingDisplay(ability)) {
                      <div class="output-badge output-badge--healing">
                        <span class="material-symbols-outlined">healing</span>
                        <span class="output-badge__value">{{ getHealingDisplay(ability) }}</span>
                      </div>
                    } @else if (isSummon(ability)) {
                      <div class="output-badge output-badge--summon">
                        <span class="material-symbols-outlined">pets</span>
                        <span class="output-badge__value">{{ getSummonName(ability) }}</span>
                      </div>
                    } @else if (getEffectSummary(ability)) {
                      <div class="output-badge output-badge--effect">
                        <span class="material-symbols-outlined">auto_awesome</span>
                        <span class="output-badge__value">{{ getEffectSummary(ability) }}</span>
                      </div>
                    }
                  </div>
                  
                  <!-- AP cost -->
                  <div class="ability-row__ap">
                    @if (ability.apCost !== null) {
                      <span class="ap-badge">
                        <span class="ap-badge__value">{{ ability.apCost }}</span>
                        <span class="ap-badge__label">AP</span>
                      </span>
                    } @else {
                      <span class="ap-badge ap-badge--passive">
                        <span class="material-symbols-outlined">brightness_auto</span>
                      </span>
                    }
                  </div>
                  
                  <!-- Expand chevron -->
                  <span class="material-symbols-outlined ability-row__chevron">
                    expand_more
                  </span>
                </button>

                <!-- Expanded Details (collapsible) -->
                <div class="ability-row__details">
                  <div class="ability-details">
                    <!-- Description -->
                    <div class="ability-details__section ability-details__description">
                      <p>{{ ability.description }}</p>
                    </div>

                    <!-- Stats Grid -->
                    <div class="ability-details__stats-grid">
                      <div class="stat-item">
                        <span class="material-symbols-outlined">straighten</span>
                        <span class="stat-item__label">Range</span>
                        <span class="stat-item__value">{{ ability.range }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="material-symbols-outlined">schedule</span>
                        <span class="stat-item__label">Duration</span>
                        <span class="stat-item__value">{{ ability.duration }}</span>
                      </div>
                      <div class="stat-item">
                        <span class="material-symbols-outlined">target</span>
                        <span class="stat-item__label">Target</span>
                        <span class="stat-item__value">{{ ability.target }}</span>
                      </div>
                      @if (ability.areaOfEffect) {
                        <div class="stat-item">
                          <span class="material-symbols-outlined">radio_button_unchecked</span>
                          <span class="stat-item__label">Area</span>
                          <span class="stat-item__value">{{ ability.areaOfEffect.size }} {{ ability.areaOfEffect.shape }}</span>
                        </div>
                      }
                    </div>

                    <!-- Costs Section -->
                    @if (ability.componentCost?.length || ability.staminaCost || hasSanityCost(ability)) {
                      <div class="ability-details__section">
                        <h4 class="ability-details__section-title">Costs</h4>
                        <div class="ability-details__costs">
                          @if (ability.staminaCost) {
                            <span class="cost-tag">
                              <span class="material-symbols-outlined">{{ getCostIcon('ST') }}</span>
                              {{ ability.staminaCost }} Stamina
                            </span>
                          }
                          @if (hasSanityCost(ability)) {
                            <span class="cost-tag cost-tag--sanity">
                              <span class="material-symbols-outlined">{{ getCostIcon('SY') }}</span>
                              {{ ability.sanityCost }} Sanity
                            </span>
                          }
                          @for (cost of ability.componentCost; track cost.type) {
                            <span class="cost-tag" [title]="getCostTypeName(cost.type)">
                              <span class="material-symbols-outlined">{{ getCostIcon(cost.type) }}</span>
                              {{ formatComponentCost(cost) }}
                            </span>
                          }
                        </div>
                      </div>
                    }

                    <!-- Summon Details -->
                    @if (ability.summon?.creature; as creature) {
                      <div class="ability-details__section">
                        <h4 class="ability-details__section-title">Summon: {{ creature.name }}</h4>
                        <div class="summon-stats">
                          <span class="summon-stat">
                            <span class="material-symbols-outlined">favorite</span>
                            HP: {{ creature.hp }}
                          </span>
                          <span class="summon-stat">
                            <span class="material-symbols-outlined">directions_run</span>
                            ST: {{ creature.stamina }}
                          </span>
                        </div>
                        @if (creature.attacks.length) {
                          <div class="summon-attacks">
                            @for (attack of creature.attacks; track attack.name) {
                              <div class="summon-attack">
                                <span class="summon-attack__name">{{ attack.name }}</span>
                                <span class="summon-attack__damage">{{ attack.damage }} {{ attack.damageType || '' }}</span>
                                <span class="summon-attack__cost">{{ attack.apCost }} AP</span>
                                @if (attack.special) {
                                  <span class="summon-attack__special">{{ attack.special }}</span>
                                }
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }

                    <!-- Effects Section -->
                    @if (ability.effects) {
                      <div class="ability-details__section">
                        <h4 class="ability-details__section-title">Effects</h4>
                        <div class="ability-effects">
                          @if (ability.effects.diceModifiers?.length) {
                            @for (mod of ability.effects.diceModifiers; track $index) {
                              <div class="effect-item">
                                <span class="material-symbols-outlined">casino</span>
                                <span>{{ mod.amount > 0 ? '+' : '' }}{{ mod.amount }} D20 on {{ mod.applies }}</span>
                                @if (mod.duration) {
                                  <span class="effect-duration">({{ mod.duration }})</span>
                                }
                              </div>
                            }
                          }
                          @if (ability.effects.statModifiers?.length) {
                            @for (mod of ability.effects.statModifiers; track $index) {
                              <div class="effect-item">
                                <span class="material-symbols-outlined">trending_up</span>
                                <span>{{ mod.amount > 0 ? '+' : '' }}{{ mod.amount }} to {{ mod.stats === 'all' ? 'all stats' : mod.stats }}</span>
                              </div>
                            }
                          }
                          @if (ability.effects.movement) {
                            <div class="effect-item">
                              <span class="material-symbols-outlined">directions_walk</span>
                              <span>{{ ability.effects.movement.amount > 0 ? '+' : '' }}{{ ability.effects.movement.amount }} ft. movement</span>
                            </div>
                          }
                          @if (ability.effects.appliesConditions?.length) {
                            @for (cond of ability.effects.appliesConditions; track cond.condition) {
                              <div class="effect-item effect-item--condition">
                                <span class="material-symbols-outlined">warning</span>
                                <span>Applies {{ cond.condition }}</span>
                                @if (cond.duration) {
                                  <span class="effect-duration">({{ cond.duration }})</span>
                                }
                              </div>
                            }
                          }
                          @if (ability.effects.resistances?.length) {
                            <div class="effect-item effect-item--buff">
                              <span class="material-symbols-outlined">shield</span>
                              <span>Resistance to {{ ability.effects.resistances!.join(', ') }}</span>
                            </div>
                          }
                          @if (ability.effects.grants?.length) {
                            @for (grant of ability.effects.grants; track grant) {
                              <div class="effect-item effect-item--buff">
                                <span class="material-symbols-outlined">add_circle</span>
                                <span>{{ grant }}</span>
                              </div>
                            }
                          }
                          @if (ability.effects.special?.length) {
                            @for (special of ability.effects.special; track special) {
                              <div class="effect-item">
                                <span class="material-symbols-outlined">star</span>
                                <span>{{ special }}</span>
                              </div>
                            }
                          }
                        </div>
                      </div>
                    }

                    <!-- Reaction Trigger -->
                    @if (ability.reactionTrigger) {
                      <div class="ability-details__section">
                        <h4 class="ability-details__section-title">Trigger</h4>
                        <p class="reaction-trigger">{{ ability.reactionTrigger.event }}</p>
                      </div>
                    }

                    <!-- Notes -->
                    @if (ability.notes) {
                      <div class="ability-details__section ability-details__notes">
                        <span class="material-symbols-outlined">info</span>
                        <p>{{ ability.notes }}</p>
                      </div>
                    }

                    <!-- Tags & Meta -->
                    <div class="ability-details__footer">
                      <div class="ability-tags">
                        @if (ability.isPassive) {
                          <span class="ability-tag ability-tag--passive">Passive</span>
                        }
                        @if (ability.isRitual) {
                          <span class="ability-tag ability-tag--ritual">Ritual</span>
                        }
                        @if (ability.isSustained) {
                          <span class="ability-tag ability-tag--sustained">Sustained</span>
                        }
                        @if (isReaction(ability)) {
                          <span class="ability-tag ability-tag--reaction">Reaction</span>
                        }
                        @if (isSummon(ability)) {
                          <span class="ability-tag ability-tag--summon">Summon</span>
                        }
                      </div>
                      
                      @if (ability.detectedStats.length > 0) {
                        <div class="ability-stats-used">
                          <span class="stats-label">Uses:</span>
                          @for (stat of ability.detectedStats; track stat) {
                            <span class="stat-chip">{{ stat }}</span>
                          }
                        </div>
                      }
                    </div>
                  </div>
                </div>
              </article>
            }
          </div>
        } @else {
          <div class="no-results">
            <span class="material-symbols-outlined">search_off</span>
            <h3>No Abilities Found</h3>
            <p>Try adjusting your search or filters</p>
            <button class="btn btn-secondary" (click)="clearAllFilters()">Clear All Filters</button>
          </div>
        }
      </main>
    </div>
  }
</div>