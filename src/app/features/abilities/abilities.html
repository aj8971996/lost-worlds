<div class="abilities-page">
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb-nav">
    <a routerLink="/" class="breadcrumb-link">
      <span class="material-symbols-outlined">home</span>
      <span>Home</span>
    </a>
    <span class="breadcrumb-separator material-symbols-outlined">chevron_right</span>
    <span class="breadcrumb-current">Ability Codex</span>
  </nav>

  <!-- Page Header -->
  <header class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <span class="material-symbols-outlined">auto_fix_high</span>
        Ability Codex
      </h1>
      <p class="page-subtitle">Browse and search all abilities across schools of magic</p>
    </div>
    
    <!-- Search Bar -->
    <div class="search-container">
      <span class="material-symbols-outlined search-icon">search</span>
      <input 
        type="text" 
        class="search-input"
        placeholder="Search abilities by name, description, or effect..."
        [ngModel]="filters().search"
        (ngModelChange)="updateSearch($event)"
      />
      @if (filters().search) {
        <button class="search-clear" (click)="updateSearch('')">
          <span class="material-symbols-outlined">close</span>
        </button>
      }
    </div>
  </header>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <div class="loading-spinner">
        <span class="material-symbols-outlined">progress_activity</span>
      </div>
      <p>Loading abilities...</p>
    </div>
  }

  <!-- Error State -->
  @else if (error()) {
    <div class="error-state">
      <span class="material-symbols-outlined">error</span>
      <h2>Failed to Load</h2>
      <p>{{ error() }}</p>
      <button class="btn btn-primary" (click)="ngOnInit()">Try Again</button>
    </div>
  }

  <!-- Main Content -->
  @else {
    <div class="content-layout">
      <!-- Sidebar Filters -->
      <aside class="filters-sidebar">
        <div class="filters-header">
          <div class="filters-title">
            <span class="material-symbols-outlined">filter_list</span>
            <span>Filters</span>
          </div>
          @if (activeFilterCount() > 0) {
            <button class="clear-all-btn" (click)="clearAllFilters()">
              Clear All ({{ activeFilterCount() }})
            </button>
          }
        </div>

        <!-- Magic College Filter -->
        <div class="filter-section">
          <button class="filter-section__header" (click)="toggleSection('colleges')">
            <span class="filter-section__title">Magic College</span>
            <span class="material-symbols-outlined filter-section__chevron" 
                  [class.expanded]="isSectionExpanded('colleges')">
              expand_more
            </span>
          </button>
          @if (isSectionExpanded('colleges')) {
            <div class="filter-section__content">
              @for (college of colleges; track college.id) {
                <label class="filter-checkbox" [style.--college-color]="college.color">
                  <input 
                    type="checkbox" 
                    [checked]="isFilterActive('colleges', college.id)"
                    (change)="toggleFilter('colleges', college.id)"
                  />
                  <span class="filter-checkbox__mark"></span>
                  <span class="filter-checkbox__label">{{ college.name }}</span>
                </label>
              }
            </div>
          }
        </div>

        <!-- Schools Filter (grouped by college) -->
        <div class="filter-section">
          <button class="filter-section__header" (click)="toggleSection('schools')">
            <span class="filter-section__title">Schools</span>
            <span class="material-symbols-outlined filter-section__chevron"
                  [class.expanded]="isSectionExpanded('schools')">
              expand_more
            </span>
          </button>
          @if (isSectionExpanded('schools')) {
            <div class="filter-section__content">
              @for (college of colleges; track college.id) {
                <div class="school-group">
                  <span class="school-group__label" [style.color]="college.color">{{ college.name }}</span>
                  @for (school of schoolsByCollege[college.id]; track school.id) {
                    <label class="filter-checkbox filter-checkbox--nested">
                      <input 
                        type="checkbox"
                        [checked]="isFilterActive('schools', school.id)"
                        (change)="toggleFilter('schools', school.id)"
                      />
                      <span class="filter-checkbox__mark"></span>
                      <span class="filter-checkbox__label">{{ school.name }}</span>
                    </label>
                  }
                </div>
              }
            </div>
          }
        </div>

        <!-- Stats Used Filter -->
        <div class="filter-section">
          <button class="filter-section__header" (click)="toggleSection('stats')">
            <span class="filter-section__title">Stats Used</span>
            <span class="material-symbols-outlined filter-section__chevron"
                  [class.expanded]="isSectionExpanded('stats')">
              expand_more
            </span>
          </button>
          @if (isSectionExpanded('stats')) {
            <div class="filter-section__content filter-section__content--grid">
              @for (stat of statOptions; track stat) {
                <label class="filter-checkbox filter-checkbox--compact">
                  <input 
                    type="checkbox"
                    [checked]="isFilterActive('stats', stat)"
                    (change)="toggleFilter('stats', stat)"
                  />
                  <span class="filter-checkbox__mark"></span>
                  <span class="filter-checkbox__label">{{ stat }}</span>
                </label>
              }
            </div>
          }
        </div>

        <!-- Source Type Filter -->
        <div class="filter-section">
          <button class="filter-section__header" (click)="toggleSection('sourceTypes')">
            <span class="filter-section__title">Source Type</span>
            <span class="material-symbols-outlined filter-section__chevron"
                  [class.expanded]="isSectionExpanded('sourceTypes')">
              expand_more
            </span>
          </button>
          @if (isSectionExpanded('sourceTypes')) {
            <div class="filter-section__content">
              @for (source of sourceTypes; track source.id) {
                <label class="filter-checkbox">
                  <input 
                    type="checkbox"
                    [checked]="isFilterActive('sourceTypes', source.id)"
                    (change)="toggleFilter('sourceTypes', source.id)"
                  />
                  <span class="filter-checkbox__mark"></span>
                  <span class="filter-checkbox__label">{{ source.name }}</span>
                </label>
              }
            </div>
          }
        </div>

        <!-- Ability Type Filter -->
        <div class="filter-section">
          <button class="filter-section__header" (click)="toggleSection('abilityTypes')">
            <span class="filter-section__title">Ability Type</span>
            <span class="material-symbols-outlined filter-section__chevron"
                  [class.expanded]="isSectionExpanded('abilityTypes')">
              expand_more
            </span>
          </button>
          @if (isSectionExpanded('abilityTypes')) {
            <div class="filter-section__content">
              @for (type of abilityTypes; track type.id) {
                <label class="filter-checkbox">
                  <input 
                    type="checkbox"
                    [checked]="isFilterActive('abilityTypes', type.id)"
                    (change)="toggleFilter('abilityTypes', type.id)"
                  />
                  <span class="filter-checkbox__mark"></span>
                  <span class="filter-checkbox__label">{{ type.name }}</span>
                </label>
              }
            </div>
          }
        </div>

        <!-- AP Cost Filter -->
        <div class="filter-section">
          <button class="filter-section__header" (click)="toggleSection('apCost')">
            <span class="filter-section__title">AP Cost</span>
            <span class="material-symbols-outlined filter-section__chevron"
                  [class.expanded]="isSectionExpanded('apCost')">
              expand_more
            </span>
          </button>
          @if (isSectionExpanded('apCost')) {
            <div class="filter-section__content">
              @for (cost of apCostOptions; track cost.id) {
                <label class="filter-checkbox">
                  <input 
                    type="checkbox"
                    [checked]="isFilterActive('apCost', cost.id)"
                    (change)="toggleFilter('apCost', cost.id)"
                  />
                  <span class="filter-checkbox__mark"></span>
                  <span class="filter-checkbox__label">{{ cost.name }}</span>
                </label>
              }
            </div>
          }
        </div>
      </aside>

      <!-- Results Area -->
      <main class="results-area">
        <!-- Results Header -->
        <div class="results-header">
          <span class="results-count">
            Showing <strong>{{ filteredAbilities().length }}</strong> 
            of {{ abilities().length }} abilities
          </span>
          
          <!-- Active Filters Pills -->
          @if (activeFilterCount() > 0) {
            <div class="active-filters">
              @for (college of filters().colleges; track college) {
                <button class="filter-pill filter-pill--college" 
                        [style.--pill-color]="getCollegeColor(college)"
                        (click)="toggleFilter('colleges', college)">
                  {{ college }}
                  <span class="material-symbols-outlined">close</span>
                </button>
              }
              @for (school of filters().schools; track school) {
                <button class="filter-pill" (click)="toggleFilter('schools', school)">
                  {{ school }}
                  <span class="material-symbols-outlined">close</span>
                </button>
              }
              @for (stat of filters().stats; track stat) {
                <button class="filter-pill filter-pill--stat" (click)="toggleFilter('stats', stat)">
                  {{ stat }}
                  <span class="material-symbols-outlined">close</span>
                </button>
              }
              @for (sourceType of filters().sourceTypes; track sourceType) {
                <button class="filter-pill" (click)="toggleFilter('sourceTypes', sourceType)">
                  {{ sourceType }}
                  <span class="material-symbols-outlined">close</span>
                </button>
              }
              @for (abilityType of filters().abilityTypes; track abilityType) {
                <button class="filter-pill" (click)="toggleFilter('abilityTypes', abilityType)">
                  {{ abilityType }}
                  <span class="material-symbols-outlined">close</span>
                </button>
              }
              @for (cost of filters().apCost; track cost) {
                <button class="filter-pill" (click)="toggleFilter('apCost', cost)">
                  {{ cost }} AP
                  <span class="material-symbols-outlined">close</span>
                </button>
              }
            </div>
          }
        </div>

        <!-- Abilities Grid -->
        @if (filteredAbilities().length > 0) {
          <div class="abilities-grid">
            @for (ability of filteredAbilities(); track ability.id) {
              <article class="ability-card" [attr.data-college]="getAbilityCollege(ability)">
                <!-- College Indicator -->
                <div class="ability-card__college-indicator"></div>
                
                <!-- Header -->
                <header class="ability-card__header">
                  <h3 class="ability-card__name">{{ ability.name }}</h3>
                  @if (ability.apCost !== null) {
                    <div class="ability-card__ap-badge">
                      <span class="ap-value">{{ ability.apCost }}</span>
                      <span class="ap-label">AP</span>
                    </div>
                  }
                </header>

                <!-- Source / Focus -->
                <div class="ability-card__source">
                  {{ getSourceDisplayName(ability) }}
                </div>

                <!-- Description -->
                <p class="ability-card__description">{{ ability.description }}</p>

                <!-- Stats Grid -->
                <div class="ability-card__stats">
                  <div class="ability-stat">
                    <span class="material-symbols-outlined">straighten</span>
                    <span class="ability-stat__label">Range</span>
                    <span class="ability-stat__value">{{ ability.range }}</span>
                  </div>
                  <div class="ability-stat">
                    <span class="material-symbols-outlined">schedule</span>
                    <span class="ability-stat__label">Duration</span>
                    <span class="ability-stat__value">{{ ability.duration }}</span>
                  </div>
                  <div class="ability-stat">
                    <span class="material-symbols-outlined">target</span>
                    <span class="ability-stat__label">Target</span>
                    <span class="ability-stat__value">{{ ability.target }}</span>
                  </div>
                </div>

                <!-- Costs -->
                @if (ability.componentCost?.length || ability.staminaCost) {
                  <div class="ability-card__costs">
                    @if (ability.staminaCost) {
                      <span class="cost-tag">
                        <span class="material-symbols-outlined">{{ getCostIcon('ST') }}</span>
                        {{ ability.staminaCost }} ST
                      </span>
                    }
                    @for (cost of ability.componentCost; track cost.type) {
                      <span class="cost-tag">
                        <span class="material-symbols-outlined">{{ getCostIcon(cost.type) }}</span>
                        {{ cost.amount }} {{ cost.type }}
                      </span>
                    }
                  </div>
                }

                <!-- Tags / Badges -->
                <footer class="ability-card__footer">
                  <div class="ability-card__tags">
                    @if (ability.isPassive) {
                      <span class="ability-tag ability-tag--passive">Passive</span>
                    }
                    @if (ability.isRitual) {
                      <span class="ability-tag ability-tag--ritual">Ritual</span>
                    }
                    @if (ability.isSustained) {
                      <span class="ability-tag ability-tag--sustained">Sustained</span>
                    }
                  </div>
                  
                  @if (ability.detectedStats.length > 0) {
                    <div class="ability-card__detected-stats">
                      @for (stat of ability.detectedStats; track stat) {
                        <span class="stat-chip">{{ stat }}</span>
                      }
                    </div>
                  }
                </footer>
              </article>
            }
          </div>
        } @else {
          <!-- No Results -->
          <div class="no-results">
            <span class="material-symbols-outlined">search_off</span>
            <h3>No Abilities Found</h3>
            <p>Try adjusting your search or filters</p>
            <button class="btn btn-secondary" (click)="clearAllFilters()">Clear All Filters</button>
          </div>
        }
      </main>
    </div>
  }
</div>